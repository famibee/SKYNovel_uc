var i=require("path"),e=require("fs-extra");const[,,w,P,m,f]=process.argv,d=require("sharp"),v=/^.+\/(_notes|Icon\r|\.[^\/]+|[^\/]+\.(db|ini|git))$/;function b(s,p,l){(0,e.readdirSync)(s,{withFileTypes:!0}).forEach(o=>{const n=String(o.name).normalize("NFC");if(v.test(n))return;if(o.isDirectory()){l(n);return}const t=(0,i.resolve)(s,n);p(t,n)})}function g(s,p,l,o=s){try{if(!(0,e.existsSync)(s)){console.error(`replaceFile no exists src:${s}`);return}const n=(0,e.readFileSync)(s,{encoding:"utf8"}),t=String(n.replace(p,l));n!==t&&(0,e.writeFileSync)(o,t)}catch(n){console.error(`replaceFile src:${s} ${n}`)}}const N=/\.(jpe?g|png)$/,$=/\.webp$/,z=/\.(htm|html)$/,h=/\w+\/\*WEBP\*\//g,y=/\.json$/,F=/("image"\s*:\s*")(.+)\.(jpe?g|png)"/,R=/webp","image_bkup":".+(jpe?g|png)"/;let S={sum:{baseSize:0,webpSize:0},hSize:{}};const _=(s=-1)=>{(0,e.writeJsonSync)(__filename+"on",S,{encoding:"utf8"}),s>-1&&process.exit(s)},a=[];function E(s,p){a.push(()=>(0,e.move)(p,s,{overwrite:!0}).then(async()=>{const{dir:l,name:o}=(0,i.parse)(p),{dir:n}=(0,i.parse)(s),t=n+"/"+o+".webp",c=await d(s).webp({quality:Number(P)}).toFile(t);await(0,e.move)(t,l+"/"+o+".webp",{overwrite:!0});const r=(0,e.statSync)(s).size,u=c.size;S.hSize[o]={baseSize:r,webpSize:u},S.sum.baseSize+=r,S.sum.webpSize+=u}))}switch(w){case"restore":b(m,()=>{},t=>{b((0,i.resolve)(m,t),(c,r)=>{if($.test(r)){a.push(()=>(0,e.remove)(c));return}z.test(r)&&(h.lastIndex=0,a.push(async()=>g(c,h,"false/*WEBP*/"))),y.test(r)&&a.push(async()=>g(c,R,'$1"'))},()=>{})}),b(f,()=>{},t=>{const c=(0,i.resolve)(m,t);b((0,i.resolve)(f,t),(r,u)=>{a.push(()=>(0,e.move)(r,(0,i.resolve)(c,u),{overwrite:!0}))},()=>{})}),Promise.allSettled(a.map(t=>t())).then(()=>(0,e.removeSync)(f)).then(()=>_(0));break;case"all":(0,e.ensureDir)(f),b(m,()=>{},t=>{const c=(0,i.resolve)(f,t);(0,e.ensureDir)(c),b((0,i.resolve)(m,t),(r,u)=>{if(N.test(u)){E((0,i.resolve)(c,u),r);return}z.test(u)&&a.push(async()=>g(r,h,"true/*WEBP*/")),y.test(u)&&a.push(async()=>g(r,F,'$1$2.webp","image_bkup":"$2.$3"'))},()=>{})}),Promise.allSettled(a.map(t=>t())).then(()=>_(0));break;default:const s=__filename+"on";(0,e.existsSync)(s)&&(S=(0,e.readJsonSync)(s,{encoding:"utf8"}));const p=w,l=m,{name:o}=(0,i.parse)(p),n=S.hSize[o]??{baseSize:0,webpSize:0};S.sum.baseSize-=n.baseSize,S.sum.webpSize-=n.webpSize,E(l,p),Promise.allSettled(a.map(t=>t())).then(()=>_(0));break}
